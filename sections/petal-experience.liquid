<div
  class="petal-experience-section"
  style="
    width: 100%;
    height: {{ section.settings.height }}vh;
    position: {{ section.settings.position_type }};
    z-index: {{ section.settings.z_index }};
    overflow: hidden;
    background-color: {{ section.settings.bg_color }};
  "
>
  <h1 style="position: absolute; width: 1px; height: 1px; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap;">
    {{ section.settings.target_text }}
  </h1>

  <div
    class="canvas-container"
    style="
      position: absolute;
      inset: 0;
      z-index: 0;
      {% if section.settings.enable_glow %}
      filter: blur({{ section.settings.blur_amount }}px);
      {% endif %}
    "
  >
    <canvas
      id="petal-canvas-{{ section.id }}"
      style="width: 100%; height: 100%; display: block;"
    ></canvas>
  </div>

  <div
    class="floor-gradient"
    style="position: absolute; bottom: 0; left: 0; width: 100%; height: 60px; background: linear-gradient(to top, rgba(0,0,0,0.05), transparent); pointer-events: none; z-index: 2;"
  ></div>

  {%- if section.settings.show_controls -%}
    <div id="controls-{{ section.id }}" class="controls-panel">
      <h2 style="font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">
        Experience Controls
      </h2>

      <div class="control-group">
        <label class="control-label">Interaction Mode</label>
        <div class="radio-group">
          <label class="radio-option">
            <input
              type="radio"
              name="auto-mode-{{ section.id }}"
              value="manual"
              {% if section.settings.interaction_mode == 'manual' %}
                checked
              {% endif %}
            >
            <span>Manual</span>
          </label>
          <label class="radio-option">
            <input
              type="radio"
              name="auto-mode-{{ section.id }}"
              value="autopop"
              {% if section.settings.interaction_mode == 'autopop' %}
                checked
              {% endif %}
            >
            <span>Auto-Pop</span>
          </label>
          <label class="radio-option">
            <input
              type="radio"
              name="auto-mode-{{ section.id }}"
              value="autotext"
              {% if section.settings.interaction_mode == 'autotext' %}
                checked
              {% endif %}
            >
            <span>Auto-Pulse Text</span>
          </label>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label">Physics Style</label>
        <div class="radio-group">
          <label class="radio-option">
            <input
              type="radio"
              name="physics-mode-{{ section.id }}"
              value="wave"
              {% if section.settings.physics_mode == 'wave' %}
                checked
              {% endif %}
            >
            <span>Wind Waves</span>
          </label>
          <label class="radio-option">
            <input
              type="radio"
              name="physics-mode-{{ section.id }}"
              value="drift"
              {% if section.settings.physics_mode == 'drift' %}
                checked
              {% endif %}
            >
            <span>Classic Drift</span>
          </label>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label">Target Text</label>
        <input
          type="text"
          id="text-input-{{ section.id }}"
          value="{{ section.settings.target_text }}"
          placeholder="Type here..."
        >
        <button id="mode-toggle-{{ section.id }}" class="toggle-btn">Form Text</button>
      </div>

      <div class="control-group">
        <label class="control-label">Base Petal Color</label>
        <input type="color" id="color-control-{{ section.id }}" value="{{ section.settings.petal_color }}">
      </div>

      <div class="control-group">
        <label class="control-label">Animation Speed</label>
        <input
          type="range"
          id="speed-control-{{ section.id }}"
          min="0.1"
          max="2.0"
          step="0.1"
          value="{{ section.settings.float_speed }}"
        >
      </div>

      <div class="control-group">
        <label class="control-label">Density (Amount)</label>
        <input
          type="range"
          id="density-control-{{ section.id }}"
          min="50"
          max="600"
          step="10"
          value="{{ section.settings.density }}"
        >
      </div>
    </div>
  {%- endif -%}
</div>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,wght@1,400&family=Inter:wght@300;400;600&display=swap');

  /* Experience Controls */
  #controls-{{ section.id }}.controls-panel {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.92);
    backdrop-filter: blur(12px);
    border: 1px solid #eee;
    padding: 24px;
    border-radius: 16px;
    z-index: 100;
    width: 260px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0,0,0,0.08);
    font-family: 'Inter', sans-serif;
    color: #1a1a1a;
    text-align: left;
  }

  .control-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: #666;
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
  }

  .control-group {
    margin-bottom: 16px;
  }

  input[type="range"] {
    width: 100%;
    accent-color: #1a1a1a;
    cursor: pointer;
  }

  input[type="color"] {
    -webkit-appearance: none;
    border: none;
    width: 100%;
    height: 32px;
    cursor: pointer;
    background: none;
    padding: 0;
  }

  input[type="text"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #eee;
    border-radius: 4px;
    font-size: 14px;
    font-family: 'Bodoni Moda', serif;
    margin-bottom: 10px;
    outline: none;
    box-sizing: border-box;
  }

  /* Radio Group Styling */
  .radio-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: #f9f9f9;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 16px;
  }

  .radio-option {
    display: flex;
    align-items: center;
    font-size: 11px;
    cursor: pointer;
    gap: 8px;
  }

  .radio-option input {
    accent-color: #1a1a1a;
  }

  input[type="text"]:focus {
    border-color: #1a1a1a;
  }

  input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
  input[type="color"]::-webkit-color-swatch { border: 1px solid #eee; border-radius: 4px; }

  .toggle-btn {
    width: 100%;
    padding: 10px;
    border: 1px solid #1a1a1a;
    font-size: 10px;
    text-transform: uppercase;
    font-weight: bold;
    letter-spacing: 0.1em;
    transition: all 0.3s ease;
    margin-bottom: 10px;
    background: transparent;
    cursor: pointer;
  }

  .toggle-btn.active {
    background: #1a1a1a;
    color: #fff;
  }
</style>

<script>
(function() {
  const containerId = "{{ section.id }}";
  const canvas = document.getElementById(`petal-canvas-${containerId}`);
  const ctx = canvas.getContext('2d', { alpha: true });
  
  // Settings
  const settings = {
    speed: {{ section.settings.float_speed }},
    driftSpeed: {{ section.settings.drift_speed }},
    swayAmount: {{ section.settings.sway_amount }},
    density: {{ section.settings.density }},
    color: '{{ section.settings.petal_color }}',
    colorSecondary: '{{ section.settings.petal_color_secondary }}',
    stringColor: '{{ section.settings.string_color }}',
    stringOpacity: {{ section.settings.string_opacity }},
    sparkColor: '{{ section.settings.spark_color }}',
    targetText: "{{ section.settings.target_text }}",
    autoMode: "{{ section.settings.interaction_mode }}",
    physicsMode: "{{ section.settings.physics_mode }}",
    isFormingText: false,
    stringCount: {{ section.settings.string_count }},
    showStrings: {{ section.settings.show_strings }},
    waveIntensity: {{ section.settings.wave_intensity }},
    enableGlow: {{ section.settings.enable_glow }},
    glowOpacity: {{ section.settings.glow_opacity }},
    sizeMin: {{ section.settings.petal_size_min }},
    sizeMax: {{ section.settings.petal_size_max }}
  };

  // Function to hex to rgb
  function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  }

  // Function to interpolate colors
  function interpolateColor(c1, c2, factor) {
    const rgb1 = hexToRgb(c1);
    const rgb2 = hexToRgb(c2);
    if (!rgb1 || !rgb2) return c1;
    const r = Math.round(rgb1.r + (rgb2.r - rgb1.r) * factor);
    const g = Math.round(rgb1.g + (rgb2.g - rgb1.g) * factor);
    const b = Math.round(rgb1.b + (rgb2.b - rgb1.b) * factor);
    return `rgb(${r}, ${g}, ${b})`;
  }

  // Generate color array based on primary and secondary
  const petalColors = [];
  for(let i = 0; i < 5; i++) {
    petalColors.push(interpolateColor(settings.color, settings.colorSecondary, i / 4));
  }

  // Mobile optimization
  const isMobile = window.innerWidth < 768;
  if (isMobile) {
    settings.density = Math.min(settings.density, 150);
  }

  // --- Noise Function ---
  function noise(x, y, z) {
    return Math.sin(x + z) * Math.cos(y + z * 0.6) + 
           Math.sin(x * 0.4 + z * 1.2) * 0.4;
  }

  // --- Offscreen Sprite Cache ---
  const spriteCache = {};
  
  function getPetalSprite(color) {
    if (spriteCache[color]) return spriteCache[color];
    const sCanvas = document.createElement('canvas');
    sCanvas.width = 64;
    sCanvas.height = 64;
    const sCtx = sCanvas.getContext('2d');
    sCtx.fillStyle = color;
    sCtx.beginPath();
    sCtx.moveTo(32, 0);
    sCtx.quadraticCurveTo(64, 32, 32, 64);
    sCtx.quadraticCurveTo(0, 32, 32, 0);
    sCtx.fill();
    spriteCache[color] = sCanvas;
    return sCanvas;
  }

  // --- Data Model ---
  let petals = [];
  let sparks = [];
  let w = 0;
  let h = 0;
  let nt = 0;
  const dpr = Math.min(window.devicePixelRatio || 1, 2);

  function createPetal(i) {
    const color = petalColors[Math.floor(Math.random() * petalColors.length)];
    return {
      x: Math.random() * w,
      y: Math.random() * h,
      vx: 0,
      vy: Math.random() * 0.5 + 0.3,
      baseSpeed: Math.random() * 0.5 + 0.5,
      rot: Math.random() * Math.PI * 2,
      rotSpeed: (Math.random() - 0.5) * 0.03,
      size: settings.sizeMin + Math.random() * (settings.sizeMax - settings.sizeMin),
      opacity: 0.3 + Math.random() * 0.6,
      waveOffset: Math.random() * Math.PI * 2,
      waveIndex: Math.floor(Math.random() * settings.stringCount),
      offsetX: (Math.random() - 0.5) * 40,
      offsetY: (Math.random() - 0.5) * 100,
      settled: false,
      settleTime: 0,
      floorLevel: h - 15 - (Math.random() * 15),
      color: color,
      sprite: getPetalSprite(color),
      tilt: 0
    };
  }

  function spawnSparks(x, y) {
    const count = isMobile ? 6 : 12;
    for (let i = 0; i < count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 3 + 1;
        sparks.push({
            x: x, y: y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            life: 1.0,
            color: settings.sparkColor
        });
    }
  }

  // --- Text Sampling ---
  const samplingCanvas = document.createElement('canvas');
  const samplingCtx = samplingCanvas.getContext('2d', { willReadFrequently: true });
  let textPoints = [];

  function updateTextPoints() {
    const text = settings.targetText || " ";
    const sampleW = 400; const sampleH = 200;
    samplingCanvas.width = sampleW; samplingCanvas.height = sampleH;
    samplingCtx.clearRect(0, 0, sampleW, sampleH);
    samplingCtx.fillStyle = '#000';
    samplingCtx.font = `italic 80px 'Bodoni Moda', serif`;
    samplingCtx.textAlign = 'center';
    samplingCtx.textBaseline = 'middle';
    samplingCtx.fillText(text, sampleW / 2, sampleH / 2);

    const imageData = samplingCtx.getImageData(0, 0, sampleW, sampleH).data;
    const points = [];
    for (let y = 0; y < sampleH; y += 6) {
      for (let x = 0; x < sampleW; x += 6) {
        if (imageData[((y * sampleW) + x) * 4 + 3] > 128) {
          points.push({ x: (x - sampleW / 2), y: (y - sampleH / 2) });
        }
      }
    }
    textPoints = points;
  }

  // --- Guiding Strings ---
  function drawStrings(nt) {
    if (!settings.showStrings) return;
    ctx.save();
    ctx.lineWidth = 1;
    for (let i = 0; i < settings.stringCount; i++) {
        ctx.beginPath();
        ctx.strokeStyle = settings.stringColor;
        ctx.globalAlpha = settings.stringOpacity;
        for (let x = 0; x <= w; x += 20) {
            const y = h * 0.5 + noise(x / 700, 0.4 * i, nt) * settings.waveIntensity;
            if (x === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.stroke();
    }
    ctx.restore();
  }

  // --- Animation Loop ---
  let lastAutoPopTime = 0;
  let isVisible = true;
  document.addEventListener('visibilitychange', () => isVisible = !document.hidden);

  function animate(now) {
    requestAnimationFrame(animate);
    if (!isVisible) return;
    nt += settings.speed * 0.01;

    ctx.clearRect(0, 0, w, h);

    if (settings.enableGlow) {
      ctx.globalCompositeOperation = 'lighter';
      ctx.globalAlpha = settings.glowOpacity;
    }
    
    drawStrings(nt);

    const cx = w / 2;
    const cy = h / 2;
    const hasTextPoints = settings.isFormingText && textPoints.length > 0;
    const textScale = Math.min(w / 400, h / 200, 3);

    for (let i = 0; i < petals.length; i++) {
        const p = petals[i];

        if (hasTextPoints) {
            const pt = textPoints[i % textPoints.length];
            p.x += (cx + pt.x * textScale - p.x) * 0.05;
            p.y += (cy + pt.y * textScale - p.y) * 0.05;
        } else if (settings.physicsMode === 'wave') {
            const waveY = h * 0.5 + noise(p.x / 700, 0.4 * p.waveIndex, nt) * settings.waveIntensity;
            const targetY = waveY + p.offsetY;
            p.y += (targetY - p.y) * 0.02;
            p.x += settings.driftSpeed * 10.0;
            if (p.x > w + 50) p.x = -50;
        } else {
            p.y += p.vy * settings.speed * 20.0;
            p.x += Math.sin(p.y * 0.005 + p.waveOffset) * settings.swayAmount;
            if (p.y >= p.floorLevel) {
                p.y = -50; p.x = Math.random() * w;
            }
        }

        p.rot += p.rotSpeed;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.globalAlpha = p.opacity;
        ctx.drawImage(p.sprite, -p.size/2, -p.size/2, p.size, p.size);
        ctx.restore();
    }

    // Sparks
    ctx.globalCompositeOperation = 'source-over';
    for (let i = sparks.length - 1; i >= 0; i--) {
        const s = sparks[i];
        s.x += s.vx; s.y += s.vy; s.life -= 0.02;
        if (s.life <= 0) { sparks.splice(i, 1); continue; }
        ctx.globalAlpha = s.life;
        ctx.fillStyle = s.color;
        ctx.beginPath(); ctx.arc(s.x, s.y, 2, 0, Math.PI * 2); ctx.fill();
    }

    if (settings.autoMode === 'autopop' && now - lastAutoPopTime > 400) {
        const p = petals[Math.floor(Math.random() * petals.length)];
        spawnSparks(p.x, p.y);
        lastAutoPopTime = now;
    }
  }

  // --- Interaction ---
  canvas.addEventListener('pointerdown', e => {
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
    const my = (e.clientY - rect.top) * (canvas.height / rect.height);
    for (let i = petals.length - 1; i >= 0; i--) {
        const p = petals[i];
        if (Math.hypot(mx - p.x, my - p.y) < p.size * 2) {
            spawnSparks(p.x, p.y);
            p.x = -50; break;
        }
    }
  });

  function resize() {
    w = canvas.width = canvas.clientWidth;
    h = canvas.height = canvas.clientHeight;
    updateTextPoints();
  }

  window.addEventListener('resize', resize);
  resize();

  for (let i = 0; i < settings.density; i++) petals.push(createPetal(i));
  requestAnimationFrame(animate);

  // Wire UI
  const modeToggle = document.getElementById(`mode-toggle-${containerId}`);
  if (modeToggle) {
    modeToggle.onclick = () => {
        settings.isFormingText = !settings.isFormingText;
        modeToggle.classList.toggle('active', settings.isFormingText);
        modeToggle.innerText = settings.isFormingText ? "Release" : "Form Text";
    };
  }
  document.querySelectorAll(`input[name="physics-mode-${containerId}"]`).forEach(r => {
      r.onchange = (e) => settings.physicsMode = e.target.value;
  });
  document.querySelectorAll(`input[name="auto-mode-${containerId}"]`).forEach(r => {
      r.onchange = (e) => settings.autoMode = e.target.value;
  });

})();
</script>

{% schema %}
{
  "name": "Petal Experience",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "position_type",
      "label": "Position Type",
      "options": [
        { "value": "relative", "label": "Relative" },
        { "value": "fixed", "label": "Fixed (Background)" },
        { "value": "absolute", "label": "Absolute" }
      ],
      "default": "fixed"
    },
    {
      "type": "number",
      "id": "z_index",
      "label": "Z-Index",
      "default": -1
    },
    {
      "type": "range",
      "id": "height",
      "label": "Section Height (vh)",
      "min": 50,
      "max": 100,
      "step": 5,
      "default": 100
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#050505"
    },
    {
      "type": "header",
      "content": "Visual Modes"
    },
    {
      "type": "select",
      "id": "physics_mode",
      "label": "Physics Style",
      "options": [
        { "value": "wave", "label": "Wind Waves" },
        { "value": "drift", "label": "Classic Drift" }
      ],
      "default": "wave"
    },
    {
      "type": "header",
      "content": "General Physics"
    },
    {
      "type": "range",
      "id": "float_speed",
      "label": "General Speed",
      "min": 0.1,
      "max": 2.0,
      "step": 0.1,
      "default": 0.6
    },
    {
      "type": "range",
      "id": "drift_speed",
      "label": "Wave Drift Speed",
      "min": 0.1,
      "max": 2.0,
      "step": 0.1,
      "default": 0.6
    },
    {
      "type": "range",
      "id": "sway_amount",
      "label": "Classic Sway Amount",
      "min": 0,
      "max": 10,
      "step": 0.5,
      "default": 0.5
    },
    {
      "type": "range",
      "id": "density",
      "label": "Petal density",
      "min": 50,
      "max": 600,
      "step": 10,
      "default": 200
    },
    {
      "type": "header",
      "content": "Wind Waves & Strings"
    },
    {
      "type": "checkbox",
      "id": "show_strings",
      "label": "Show Wind Currents (Strings)",
      "default": true
    },
    {
      "type": "color",
      "id": "string_color",
      "label": "String Color",
      "default": "#f9a8d4"
    },
    {
      "type": "range",
      "id": "string_opacity",
      "label": "String Opacity",
      "min": 0,
      "max": 1,
      "step": 0.1,
      "default": 0.1
    },
    {
      "type": "range",
      "id": "string_count",
      "label": "Current Count",
      "min": 1,
      "max": 10,
      "default": 5
    },
    {
      "type": "range",
      "id": "wave_intensity",
      "label": "Wave Amplitude",
      "min": 20,
      "max": 400,
      "step": 10,
      "default": 160
    },
    {
      "type": "header",
      "content": "Petal Aesthetics"
    },
    {
      "type": "color",
      "id": "petal_color",
      "label": "Base Color (Primary)",
      "default": "#f9a8d4"
    },
    {
      "type": "color",
      "id": "petal_color_secondary",
      "label": "Blossom Color (Secondary)",
      "default": "#fff1f2"
    },
    {
      "type": "range",
      "id": "petal_size_min",
      "label": "Min Size",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "petal_size_max",
      "label": "Max Size",
      "min": 5,
      "max": 30,
      "step": 1,
      "default": 14
    },
    {
      "type": "header",
      "content": "Bloom / Glow"
    },
    {
      "type": "checkbox",
      "id": "enable_glow",
      "label": "Enable Bloom/Glow",
      "default": true
    },
    {
      "type": "range",
      "id": "glow_opacity",
      "label": "Glow Intensity",
      "min": 0.1,
      "max": 1,
      "step": 0.1,
      "default": 0.9
    },
    {
      "type": "range",
      "id": "blur_amount",
      "label": "Bloom Blur",
      "min": 0,
      "max": 5,
      "step": 0.5,
      "default": 1.5
    },
    {
      "type": "header",
      "content": "Interaction"
    },
    {
      "type": "select",
      "id": "interaction_mode",
      "label": "Default Interaction",
      "options": [
        { "value": "manual", "label": "Manual" },
        { "value": "autopop", "label": "Auto-Burst" },
        { "value": "autotext", "label": "Auto-Form Text" }
      ],
      "default": "manual"
    },
    {
      "type": "text",
      "id": "target_text",
      "label": "Target Text",
      "default": "rumani dhaage"
    },
    {
      "type": "color",
      "id": "spark_color",
      "label": "Interaction Spark Color",
      "default": "#fff1f2"
    },
    {
      "type": "checkbox",
      "id": "show_controls",
      "label": "Show Debug Controls on Page",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Petal Experience"
    }
  ]
}
{% endschema %}
