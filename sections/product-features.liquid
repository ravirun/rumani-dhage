{{ 'product-features.css' | asset_url | stylesheet_tag }}

{%- comment -%}
  Metafield Logic:
  If metafields exist (e.g. custom.feature_1_title), we use them.
  Otherwise, we fallback to the Blocks.
{%- endcomment -%}

{%- assign heading = section.settings.heading -%}
{%- if product.metafields.custom.feature_heading != blank -%}
  {%- assign heading = product.metafields.custom.feature_heading -%}
{%- endif -%}

{%- assign hero_image = section.settings.image -%}
{%- if product.metafields.custom.feature_image != blank -%}
  {%- assign hero_image = product.metafields.custom.feature_image -%}
{%- endif -%}

<div class="highlight-section color-{{ section.settings.color_scheme }} gradient">
  <div class="product-features">
    <div class="feature-container">
      <!-- Left: Text List -->
      <div class="feature-list">
        <h2 style="font-family:var(--font-heading-family);font-size:2.8rem;margin-bottom:1rem;">{{ heading }}</h2>

        {%- comment -%} Render Metafield Features if 1st one exists {%- endcomment -%}
        {%- if product.metafields.custom.feature_1_title != blank -%}
          {%- for i in (1..3) -%}
            {%- assign title_key = 'feature_' | append: i | append: '_title' -%}
            {%- assign text_key = 'feature_' | append: i | append: '_text' -%}
            {%- assign icon_key = 'feature_' | append: i | append: '_icon' -%}

            {%- if product.metafields.custom[title_key] != blank -%}
              <div class="feature-item">
                {%- if product.metafields.custom[icon_key] != blank -%}
                  <div class="feature-icon">
                    <img
                      src="{{ product.metafields.custom[icon_key] | image_url: width: 80 }}"
                      alt=""
                      loading="lazy"
                      width="40"
                      height="40"
                    >
                  </div>
                {%- endif -%}
                <div class="feature-content">
                  <h3>{{ product.metafields.custom[title_key] }}</h3>
                  <p>{{ product.metafields.custom[text_key] }}</p>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}

        {%- else -%}
          {%- comment -%} Fallback to Block Settings {%- endcomment -%}
          {%- for block in section.blocks -%}
            {%- if block.type == 'feature' -%}
              <div class="feature-item">
                {%- if block.settings.icon != blank -%}
                  <div class="feature-icon">
                    <img
                      src="{{ block.settings.icon | image_url: width: 80 }}"
                      alt=""
                      loading="lazy"
                      width="40"
                      height="40"
                    >
                  </div>
                {%- endif -%}
                <div class="feature-content">
                  <h3>{{ block.settings.title }}</h3>
                  <p>{{ block.settings.text }}</p>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      </div>

      <!-- Right: Hero Image & Badges -->
      <div class="feature-hero">
        {%- if hero_image != blank -%}
          <img
            src="{{ hero_image | image_url: width: 600 }}"
            class="feature-hero__img"
            alt=""
            loading="lazy"
            width="600"
            height="{{ 600 | divided_by: hero_image.aspect_ratio | round }}"
          >
        {%- else -%}
          {{ 'product-1' | placeholder_svg_tag: 'feature-hero__img placeholder-svg' }}
        {%- endif -%}

        {%- for block in section.blocks -%}
          {%- if block.type == 'badge' -%}
            <div
              class="feature-badge {% if forloop.index > 1 %}feature-badge--secondary{% endif %}"
              style="top: {{ block.settings.desktop_y }}%; left: {{ block.settings.desktop_x }}%;"
            >
              {%- if block.settings.icon_emoji != blank -%}
                <span>{{ block.settings.icon_emoji }}</span>
              {%- endif -%}
              {{ block.settings.text }}
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Product Features",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Supports Dynamic Metafields: custom.feature_heading, custom.feature_image, custom.feature_1_title, etc."
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading (Fallback)",
      "default": "THE MOST DELICIOUS SAREE COLLECTION"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Hero Image (Fallback)"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    }
  ],
  "blocks": [
    {
      "type": "feature",
      "name": "Feature Item (Fallback)",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Pure Silk"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "Description",
          "default": "Made from authentic hand-woven silk."
        },
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Icon"
        }
      ]
    },
    {
      "type": "badge",
      "name": "Floating Badge",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "Certified"
        },
        {
          "type": "text",
          "id": "icon_emoji",
          "label": "Emoji/Icon",
          "default": "ðŸŒ¿"
        },
        {
          "type": "range",
          "id": "desktop_x",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Horizontal Position",
          "default": 10
        },
        {
          "type": "range",
          "id": "desktop_y",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Vertical Position",
          "default": 10
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Features",
      "blocks": [
        { "type": "feature" },
        { "type": "feature" },
        { "type": "badge", "settings": { "desktop_x": 10, "desktop_y": 20, "text": "Silk Mark" } },
        { "type": "badge", "settings": { "desktop_x": 80, "desktop_y": 80, "text": "Handmade" } }
      ]
    }
  ]
}
{% endschema %}
