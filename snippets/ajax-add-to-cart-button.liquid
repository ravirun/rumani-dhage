{% comment %}
  Ajax Add to Cart Button
  Button component that adds products to cart using Ajax API
  
  @param {number} variant_id - Product variant ID (required)
  @param {string} text - Button text (default: 'Add to Cart')
  @param {string} variant - Button style variant (default: 'primary')
  @param {string} size - Button size (default: 'medium')
  @param {number} quantity - Quantity to add (default: 1)
  @param {object} properties - Line item properties (optional)
  @param {string} class - Additional CSS classes
{% endcomment %}

{% liquid
  assign variant_id = variant_id | default: ''
  assign text = text | default: 'Add to Cart'
  assign variant = variant | default: 'primary'
  assign size = size | default: 'medium'
  assign quantity = quantity | default: 1
  assign class = class | default: ''
  
  unless variant_id != blank
    echo '<!-- Error: variant_id parameter required for ajax-add-to-cart-button -->'
    break
  endunless
%}

<button 
  type="button"
  class="ajax-add-to-cart ds-button ds-button--{{ variant }} ds-button--{{ size }} {{ class }}"
  data-variant-id="{{ variant_id }}"
  data-quantity="{{ quantity }}"
  {% if properties %}data-properties="{{ properties | json | escape }}"{% endif %}
>
  <span class="ajax-add-to-cart__text">{{ text }}</span>
  <span class="ajax-add-to-cart__loading" style="display: none;">
    <span class="ajax-cart-spinner" style="width: 1em; height: 1em; border-width: 2px;"></span>
    Adding...
  </span>
</button>

{% javascript %}
  (function() {
    if (typeof window.AjaxCart === 'undefined') {
      console.warn('AjaxCart not loaded. Add to cart buttons will not work.');
      return;
    }

    document.addEventListener('click', async function(e) {
      const button = e.target.closest('.ajax-add-to-cart');
      if (!button) return;

      e.preventDefault();
      
      const variantId = parseInt(button.getAttribute('data-variant-id'));
      const quantity = parseInt(button.getAttribute('data-quantity')) || 1;
      const propertiesJson = button.getAttribute('data-properties');
      let properties = {};
      
      if (propertiesJson) {
        try {
          properties = JSON.parse(propertiesJson);
        } catch (error) {
          console.warn('Invalid properties JSON:', error);
        }
      }

      if (!variantId) {
        console.error('Variant ID is required');
        return;
      }

      // Show loading state
      const textSpan = button.querySelector('.ajax-add-to-cart__text');
      const loadingSpan = button.querySelector('.ajax-add-to-cart__loading');
      
      if (textSpan) textSpan.style.display = 'none';
      if (loadingSpan) loadingSpan.style.display = 'inline-flex';
      button.disabled = true;

      // Add to cart
      const item = await window.AjaxCart.addItem(variantId, quantity, properties);

      // Hide loading state
      if (textSpan) textSpan.style.display = 'inline';
      if (loadingSpan) loadingSpan.style.display = 'none';
      button.disabled = false;

      // Optionally open cart drawer
      if (item && typeof window.openCartDrawer === 'function') {
        setTimeout(() => {
          window.openCartDrawer();
        }, 300);
      }
    });
  })();
{% endjavascript %}

{% stylesheet %}
  .ajax-add-to-cart {
    position: relative;
  }

  .ajax-add-to-cart__loading {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
  }

  .ajax-add-to-cart:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
{% endstylesheet %}

