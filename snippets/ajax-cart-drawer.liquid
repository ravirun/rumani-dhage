{% comment %}
  Ajax Cart Drawer
  Slide-in cart drawer that displays cart contents and allows cart management via Ajax API
{% endcomment %}

<div class="ajax-cart-drawer" id="ajax-cart-drawer" role="dialog" aria-modal="true" aria-labelledby="cart-drawer-title">
  <div class="ajax-cart-drawer__overlay" data-cart-drawer-close></div>
  <div class="ajax-cart-drawer__content">
    <div class="ajax-cart-drawer__header">
      <h2 id="cart-drawer-title" class="ajax-cart-drawer__title">Shopping Cart</h2>
      <button 
        type="button"
        class="ajax-cart-drawer__close"
        data-cart-drawer-close
        aria-label="Close cart"
      >
        <i data-lucide="x"></i>
      </button>
    </div>

    <div class="ajax-cart-drawer__body" id="cart-drawer-body">
      <div class="ajax-cart-drawer__loading">
        <div class="ajax-cart-spinner"></div>
        <p>Loading cart...</p>
      </div>
    </div>

    <div class="ajax-cart-drawer__footer" id="cart-drawer-footer" style="display: none;">
      <div class="ajax-cart-drawer__summary">
        <div class="ajax-cart-drawer__subtotal">
          <span>Subtotal:</span>
          <span id="cart-drawer-total">{{ cart.total_price | money }}</span>
        </div>
        <p class="ajax-cart-drawer__note">Taxes and shipping calculated at checkout</p>
      </div>
      <div class="ajax-cart-drawer__actions">
        <a href="{{ routes.cart_url }}" class="ajax-cart-drawer__view-cart">
          View Cart
        </a>
        <a href="{{ routes.cart_url }}" class="ajax-cart-drawer__checkout">
          Checkout
        </a>
      </div>
    </div>
  </div>
</div>

{% stylesheet %}
  .ajax-cart-drawer {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    max-width: 28rem;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    pointer-events: none;
  }

  .ajax-cart-drawer--open {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  .ajax-cart-drawer__overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
  }

  .ajax-cart-drawer__content {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    background: var(--color-background);
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .ajax-cart-drawer--open .ajax-cart-drawer__content {
    transform: translateX(0);
  }

  .ajax-cart-drawer__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--color-border);
    flex-shrink: 0;
  }

  .ajax-cart-drawer__title {
    margin: 0;
    font-size: var(--font-size-xl);
    font-weight: var(--font-primary--weight);
    color: var(--color-foreground);
  }

  .ajax-cart-drawer__close {
    background: none;
    border: none;
    padding: 0.75rem;
    min-height: 44px;
    min-width: 44px;
    cursor: pointer;
    color: var(--color-foreground);
    opacity: 0.7;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ajax-cart-drawer__close:hover {
    opacity: 1;
  }

  .ajax-cart-drawer__close i {
    width: 1.5rem;
    height: 1.5rem;
  }

  .ajax-cart-drawer__body {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-lg);
    -webkit-overflow-scrolling: touch;
  }

  .ajax-cart-drawer__loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-md);
    padding: var(--spacing-xl);
    color: var(--color-foreground);
    opacity: 0.6;
  }

  .ajax-cart-drawer__empty {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--color-foreground);
    opacity: 0.6;
  }

  .ajax-cart-drawer__empty-icon {
    width: 4rem;
    height: 4rem;
    margin: 0 auto var(--spacing-md);
    opacity: 0.3;
  }

  .ajax-cart-drawer__items {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .ajax-cart-drawer__item {
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: var(--color-secondary);
    border-radius: var(--card-border-radius);
  }

  .ajax-cart-drawer__item-image {
    width: 5rem;
    height: 5rem;
    border-radius: var(--input-border-radius);
    overflow: hidden;
    flex-shrink: 0;
    background: var(--color-border);
  }

  .ajax-cart-drawer__item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .ajax-cart-drawer__item-content {
    flex: 1;
    min-width: 0;
  }

  .ajax-cart-drawer__item-title {
    margin: 0 0 var(--spacing-xs) 0;
    font-size: var(--font-size-base);
    font-weight: var(--font-primary--weight);
    color: var(--color-foreground);
  }

  .ajax-cart-drawer__item-variant {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: var(--font-size-sm);
    color: color-mix(in srgb, var(--color-foreground) 60%, transparent);
  }

  .ajax-cart-drawer__item-price {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: var(--font-size-base);
    font-weight: calc(var(--font-primary--weight) + 200);
    color: var(--color-foreground);
  }

  .ajax-cart-drawer__item-quantity {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .ajax-cart-drawer__quantity-control {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    border: 1px solid var(--color-border);
    border-radius: var(--input-border-radius);
    overflow: hidden;
  }

  .ajax-cart-drawer__quantity-btn {
    background: none;
    border: none;
    padding: 0.375rem 0.75rem;
    cursor: pointer;
    color: var(--color-foreground);
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ajax-cart-drawer__quantity-btn:hover:not(:disabled) {
    background: color-mix(in srgb, var(--color-foreground) 5%, transparent);
  }

  .ajax-cart-drawer__quantity-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .ajax-cart-drawer__quantity-input {
    width: 3rem;
    padding: 0.375rem;
    border: none;
    text-align: center;
    font-size: var(--font-size-base);
    color: var(--color-foreground);
    background: transparent;
  }

  .ajax-cart-drawer__item-remove {
    background: none;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    color: var(--color-error);
    opacity: 0.7;
    transition: var(--transition);
    align-self: flex-start;
  }

  .ajax-cart-drawer__item-remove:hover {
    opacity: 1;
  }

  .ajax-cart-drawer__item-remove i {
    width: 1.25rem;
    height: 1.25rem;
  }

  .ajax-cart-drawer__footer {
    padding: var(--spacing-lg);
    border-top: 1px solid var(--color-border);
    flex-shrink: 0;
  }

  .ajax-cart-drawer__summary {
    margin-bottom: var(--spacing-md);
  }

  .ajax-cart-drawer__subtotal {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-xs);
    font-size: var(--font-size-lg);
    font-weight: calc(var(--font-primary--weight) + 200);
    color: var(--color-foreground);
  }

  .ajax-cart-drawer__note {
    margin: 0;
    font-size: var(--font-size-sm);
    color: color-mix(in srgb, var(--color-foreground) 60%, transparent);
  }

  .ajax-cart-drawer__actions {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .ajax-cart-drawer__view-cart,
  .ajax-cart-drawer__checkout {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--button-padding);
    border-radius: var(--button-border-radius);
    text-decoration: none;
    font-size: var(--font-size-base);
    font-weight: var(--font-primary--weight);
    transition: var(--transition);
    text-align: center;
  }

  .ajax-cart-drawer__view-cart {
    background: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-foreground);
  }

  .ajax-cart-drawer__view-cart:hover {
    background: color-mix(in srgb, var(--color-foreground) 5%, transparent);
  }

  .ajax-cart-drawer__checkout {
    background: var(--color-primary);
    color: var(--color-primary-text);
    border: 1px solid var(--color-primary);
  }

  .ajax-cart-drawer__checkout:hover {
    opacity: 0.9;
  }

  .ajax-cart-spinner {
    width: 2rem;
    height: 2rem;
    border: 3px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: ajax-cart-spin 0.8s linear infinite;
  }

  @keyframes ajax-cart-spin {
    to { transform: rotate(360deg); }
  }

  /* Mobile-first: full width on mobile */
  .ajax-cart-drawer {
    max-width: 100%;
  }

  @media screen and (min-width: 750px) {
    .ajax-cart-drawer {
      max-width: 28rem;
    }
  }

  body.ajax-cart-drawer-open {
    overflow: hidden;
  }
{% endstylesheet %}

{% javascript %}
  (function() {
    // Wait for AjaxCart to be available
    function initCartDrawer() {
      if (typeof window.AjaxCart === 'undefined') {
        // Retry after a short delay
        setTimeout(initCartDrawer, 100);
        return;
      }

    const drawer = document.getElementById('ajax-cart-drawer');
    const body = document.getElementById('cart-drawer-body');
    const footer = document.getElementById('cart-drawer-footer');
    const totalElement = document.getElementById('cart-drawer-total');
    const closeButtons = drawer?.querySelectorAll('[data-cart-drawer-close]');

    if (!drawer || !body) return;

    // Format money helper
    function formatMoney(cents) {
      return new Intl.NumberFormat(document.documentElement.lang || 'en', {
        style: 'currency',
        currency: window.Shopify?.currency?.active || 'USD'
      }).format(cents / 100);
    }

    // Render cart items
    function renderCartItems(cart) {
      if (!cart || !cart.items || cart.items.length === 0) {
        body.innerHTML = `
          <div class="ajax-cart-drawer__empty">
            <i data-lucide="shopping-cart" class="ajax-cart-drawer__empty-icon" aria-hidden="true"></i>
            <p>Your cart is empty</p>
          </div>
        `;
        footer.style.display = 'none';
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
        return;
      }

      footer.style.display = 'block';
      
      const itemsHtml = cart.items.map((item, index) => {
        const line = index + 1;
        return `
          <div class="ajax-cart-drawer__item" data-line="${line}">
            <div class="ajax-cart-drawer__item-image">
              <img 
                src="${item.image || ''}" 
                alt="${item.product_title || ''}"
                loading="lazy"
                width="80"
                height="80"
              >
            </div>
            <div class="ajax-cart-drawer__item-content">
              <h3 class="ajax-cart-drawer__item-title">${item.product_title || ''}</h3>
              ${item.variant_title && item.variant_title !== 'Default Title' ? 
                `<p class="ajax-cart-drawer__item-variant">${item.variant_title}</p>` : ''}
              <p class="ajax-cart-drawer__item-price">${formatMoney(item.line_price)}</p>
              <div class="ajax-cart-drawer__item-quantity">
                <div class="ajax-cart-drawer__quantity-control">
                  <button 
                    type="button"
                    class="ajax-cart-drawer__quantity-btn"
                    data-cart-decrease="${line}"
                    ${item.quantity <= 1 ? 'disabled' : ''}
                    aria-label="Decrease quantity for ${item.product_title || 'item'}"
                  >
                    <i data-lucide="minus" aria-hidden="true"></i>
                  </button>
                  <label for="cart-quantity-${line}" class="visually-hidden">Quantity for ${item.product_title || 'item'}</label>
                  <input 
                    type="number"
                    class="ajax-cart-drawer__quantity-input"
                    id="cart-quantity-${line}"
                    value="${item.quantity}"
                    min="1"
                    data-cart-quantity="${line}"
                    aria-label="Quantity for ${item.product_title || 'item'}"
                  >
                  <button 
                    type="button"
                    class="ajax-cart-drawer__quantity-btn"
                    data-cart-increase="${line}"
                    aria-label="Increase quantity for ${item.product_title || 'item'}"
                  >
                    <i data-lucide="plus" aria-hidden="true"></i>
                  </button>
                </div>
              </div>
            </div>
            <button 
              type="button"
              class="ajax-cart-drawer__item-remove"
              data-cart-remove="${line}"
              aria-label="Remove ${item.product_title || 'item'} from cart"
            >
              <i data-lucide="trash-2" aria-hidden="true"></i>
            </button>
          </div>
        `;
      }).join('');

      body.innerHTML = `<div class="ajax-cart-drawer__items">${itemsHtml}</div>`;
      
      if (totalElement) {
        totalElement.textContent = formatMoney(cart.total_price);
      }

      // Initialize icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }

      // Attach event listeners
      attachCartItemListeners();
    }

    // Attach event listeners to cart items
    function attachCartItemListeners() {
      // Quantity controls
      body.querySelectorAll('[data-cart-increase]').forEach(btn => {
        btn.addEventListener('click', async function() {
          const line = parseInt(this.getAttribute('data-cart-increase'));
          const input = body.querySelector(`[data-cart-quantity="${line}"]`);
          const newQuantity = parseInt(input.value) + 1;
          await window.AjaxCart.updateItem(line, newQuantity);
        });
      });

      body.querySelectorAll('[data-cart-decrease]').forEach(btn => {
        btn.addEventListener('click', async function() {
          const line = parseInt(this.getAttribute('data-cart-decrease'));
          const input = body.querySelector(`[data-cart-quantity="${line}"]`);
          const newQuantity = Math.max(1, parseInt(input.value) - 1);
          await window.AjaxCart.updateItem(line, newQuantity);
        });
      });

      // Quantity input changes
      body.querySelectorAll('[data-cart-quantity]').forEach(input => {
        input.addEventListener('change', async function() {
          const line = parseInt(this.getAttribute('data-cart-quantity'));
          const quantity = Math.max(1, parseInt(this.value) || 1);
          await window.AjaxCart.updateItem(line, quantity);
        });
      });

      // Remove buttons
      body.querySelectorAll('[data-cart-remove]').forEach(btn => {
        btn.addEventListener('click', async function() {
          const line = parseInt(this.getAttribute('data-cart-remove'));
          await window.AjaxCart.removeItem(line);
        });
      });
    }

    // Store the element that triggered the drawer open (for focus return)
    let triggerElement = null;

    // Open drawer
    function openDrawer(event) {
      // Store the element that triggered the open (if available)
      if (event && event.target) {
        triggerElement = event.target;
      } else {
        // Try to find the button that opened the drawer
        triggerElement = document.querySelector('[data-open-cart-drawer]');
      }
      
      drawer.classList.add('ajax-cart-drawer--open');
      document.body.classList.add('ajax-cart-drawer-open');
      
      // Trap focus within the drawer
      trapFocus(drawer);
      
      // Focus the close button for keyboard navigation
      const closeBtn = drawer.querySelector('[data-cart-drawer-close]');
      if (closeBtn) {
        closeBtn.focus();
      }
      
      // Fetch latest cart
      window.AjaxCart.getCart();
    }

    // Close drawer
    function closeDrawer() {
      drawer.classList.remove('ajax-cart-drawer--open');
      document.body.classList.remove('ajax-cart-drawer-open');
      
      // Return focus to the trigger element
      if (triggerElement && typeof triggerElement.focus === 'function') {
        triggerElement.focus();
      }
      triggerElement = null;
    }

    // Focus trap implementation
    function trapFocus(container) {
      const focusableElements = container.querySelectorAll(
        'a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])'
      );
      
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];

      container.addEventListener('keydown', function handleTrapKeydown(e) {
        if (e.key !== 'Tab') return;

        if (e.shiftKey) {
          // Shift + Tab
          if (document.activeElement === firstElement) {
            e.preventDefault();
            lastElement.focus();
          }
        } else {
          // Tab
          if (document.activeElement === lastElement) {
            e.preventDefault();
            firstElement.focus();
          }
        }
      });
    }

    // Close button listeners
    closeButtons?.forEach(btn => {
      btn.addEventListener('click', closeDrawer);
    });

    // Listen for cart updates
    window.AjaxCart.onUpdate((cart) => {
      renderCartItems(cart);
    });

    // Initial render
    if (window.AjaxCart.cart) {
      renderCartItems(window.AjaxCart.cart);
    } else {
      window.AjaxCart.getCart();
    }

      // Expose open/close functions globally
      window.openCartDrawer = openDrawer;
      window.closeCartDrawer = closeDrawer;

      // Listen for open events
      document.addEventListener('cart:open', function(event) {
        openDrawer(event);
      });
      
      // Close on escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && drawer.classList.contains('ajax-cart-drawer--open')) {
          closeDrawer();
        }
      });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCartDrawer);
    } else {
      initCartDrawer();
    }
  })();
{% endjavascript %}

