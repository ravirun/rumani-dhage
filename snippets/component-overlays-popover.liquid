{% comment %}
  Popover Component
  Popovers are used to display content in an overlay that can be triggered by a button.
  
  @param {string} id - Popover ID (required)
  @param {string} trigger_text - Trigger button text (required)
  @param {string} content - Popover content (required)
  @param {string} position - Popover position: top, bottom, left, right (default: bottom)
  @param {string} align - Alignment: start, center, end (default: center)
  @param {boolean} close_on_click_outside - Close on outside click (default: true)
  @param {string} class - Additional CSS classes
  @param {string} attributes - Additional HTML attributes
  
  @example
  {% render 'component-overlays-popover', id: 'my-popover', trigger_text: 'Click me', content: 'Popover content' %}
{% endcomment %}

{% liquid
  assign id = id | default: ''
  assign trigger_text = trigger_text | default: ''
  assign content = content | default: ''
  assign position = position | default: 'bottom'
  assign align = align | default: 'center'
  assign close_on_click_outside = close_on_click_outside | default: true
  assign class = class | default: ''
  assign attributes = attributes | default: ''
  
  unless id != blank and trigger_text != blank
    echo '<!-- Error: id and trigger_text parameters required for popover component -->'
    break
  endunless
  
  assign trigger_id = id | append: '-trigger'
  assign popover_id = id | append: '-popover'
%}

<div class="ds-popover {{ class }}" data-popover>
  <button 
    type="button"
    id="{{ trigger_id }}"
    class="ds-popover__trigger"
    aria-expanded="false"
    aria-haspopup="true"
    aria-controls="{{ popover_id }}"
    data-popover-trigger
    {{ attributes }}
  >
    {{ trigger_text }}
  </button>
  
  <div 
    id="{{ popover_id }}"
    class="ds-popover__content ds-popover__content--{{ position }} ds-popover__content--align-{{ align }}"
    role="dialog"
    aria-labelledby="{{ trigger_id }}"
    data-popover-content
  >
    <div class="ds-popover__arrow"></div>
    <div class="ds-popover__body">
      {{ content }}
    </div>
  </div>
</div>

{% stylesheet %}
  .ds-popover {
    position: relative;
    display: inline-block;
  }
  
  .ds-popover__trigger {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    font-family: inherit;
    font-size: inherit;
    color: inherit;
  }
  
  .ds-popover__content {
    position: absolute;
    z-index: 1000;
    background-color: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--card-border-radius);
    box-shadow: var(--shadow-lg);
    padding: var(--spacing-md);
    min-width: 12rem;
    max-width: 20rem;
    opacity: 0;
    visibility: hidden;
    transform: scale(0.95);
    transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
    pointer-events: none;
  }
  
  .ds-popover__content--open {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
    pointer-events: auto;
  }
  
  .ds-popover__content--top {
    bottom: 100%;
    margin-bottom: var(--spacing-sm);
  }
  
  .ds-popover__content--bottom {
    top: 100%;
    margin-top: var(--spacing-sm);
  }
  
  .ds-popover__content--left {
    right: 100%;
    margin-right: var(--spacing-sm);
  }
  
  .ds-popover__content--right {
    left: 100%;
    margin-left: var(--spacing-sm);
  }
  
  .ds-popover__content--align-start {
    left: 0;
  }
  
  .ds-popover__content--align-center {
    left: 50%;
    transform: translateX(-50%);
  }
  
  .ds-popover__content--align-end {
    right: 0;
  }
  
  .ds-popover__arrow {
    position: absolute;
    width: 0.5rem;
    height: 0.5rem;
    background-color: var(--color-background);
    border: 1px solid var(--color-border);
  }
  
  .ds-popover__content--top .ds-popover__arrow {
    bottom: -0.25rem;
    left: 50%;
    transform: translateX(-50%) rotate(45deg);
    border-top: none;
    border-left: none;
  }
  
  .ds-popover__content--bottom .ds-popover__arrow {
    top: -0.25rem;
    left: 50%;
    transform: translateX(-50%) rotate(45deg);
    border-bottom: none;
    border-right: none;
  }
  
  .ds-popover__body {
    position: relative;
    z-index: 1;
  }
{% endstylesheet %}

{% javascript %}
  (function() {
    const popovers = document.querySelectorAll('[data-popover]');
    
    popovers.forEach(popover => {
      const trigger = popover.querySelector('[data-popover-trigger]');
      const content = popover.querySelector('[data-popover-content]');
      
      if (!trigger || !content) return;
      
      trigger.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = content.classList.contains('ds-popover__content--open');
        
        // Close all other popovers
        document.querySelectorAll('.ds-popover__content--open').forEach(openContent => {
          if (openContent !== content) {
            openContent.classList.remove('ds-popover__content--open');
            const openTrigger = document.querySelector(`[aria-controls="${openContent.id}"]`);
            if (openTrigger) {
              openTrigger.setAttribute('aria-expanded', 'false');
            }
          }
        });
        
        if (isOpen) {
          content.classList.remove('ds-popover__content--open');
          trigger.setAttribute('aria-expanded', 'false');
        } else {
          content.classList.add('ds-popover__content--open');
          trigger.setAttribute('aria-expanded', 'true');
        }
      });
      
      // Close on outside click
      document.addEventListener('click', function(e) {
        if (!popover.contains(e.target)) {
          content.classList.remove('ds-popover__content--open');
          trigger.setAttribute('aria-expanded', 'false');
        }
      });
      
      // Close on escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && content.classList.contains('ds-popover__content--open')) {
          content.classList.remove('ds-popover__content--open');
          trigger.setAttribute('aria-expanded', 'false');
        }
      });
    });
  })();
{% endjavascript %}

